name: Build WinUninstallDoctor Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Windows SDK
        run: |
         choco install windows-sdk-10.1 --version 10.1.22621.755 -y
         choco install microsoft-build-tools -y
         choco install netfx-4.8-devpack -y 
         
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Restore NuGet packages
        run: dotnet restore WinUninstallDoctor.sln

      - name: Build MSIX package
        run: |
          msbuild WinUninstallDoctor.Package\WinUninstallDoctor.Package.wapproj /p:Configuration=Release /p:Platform=x64 /p:AppxBundle=Always /p:AppxBundlePlatforms=x64 /p:UapAppxPackageBuildMode=StoreUpload /p:AppxPackageSigningEnabled=false /p:GenerateAppInstallerFile=false
        shell: cmd

      - name: Verify MSIX package exists
        run: |
          $msixPath = Get-ChildItem -Path "WinUninstallDoctor.Package\AppPackages" -Recurse -Filter "*.msix" | Select-Object -First 1
          if (-not $msixPath) {
            Write-Error "MSIX package was not created!"
            exit 1
          }
          Write-Host "MSIX package created successfully: $($msixPath.FullName)"
        shell: powershell

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinUninstallDoctorMSIX
          path: WinUninstallDoctor.Package/AppPackages/**/*.msix
