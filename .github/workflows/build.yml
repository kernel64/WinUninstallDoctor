name: Build WinUninstallDoctor Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Copy logo.png for MSIX
        run: |
          if (-not (Test-Path "WinUninstallDoctor.Package\Assets")) {
            New-Item -ItemType Directory -Path "WinUninstallDoctor.Package\Assets" -Force | Out-Null
          }
          Copy-Item "Assets\logo.png" -Destination "WinUninstallDoctor.Package\Assets\logo.png" -Force
        shell: powershell

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Restore NuGet packages
        run: dotnet restore WinUninstallDoctor.sln

      - name: Build MSIX package
        run: |
          dotnet msbuild WinUninstallDoctor.Package\WinUninstallDoctor.Package.wapproj /p:Configuration=Release /p:Platform=x64 /p:AppxBundle=Always /p:AppxBundlePlatforms=x64 /p:UapAppxPackageBuildMode=StoreUpload /p:AppxPackageSigningEnabled=false /p:GenerateAppInstallerFile=false
        shell: cmd

      - name: Verify MSIX package exists
        run: |
          $msixPath = Get-ChildItem -Path "WinUninstallDoctor.Package\AppPackages" -Recurse -Filter "*.msix" | Select-Object -First 1
          if (-not $msixPath) {
            Write-Error "MSIX package was not created!"
            exit 1
          }
          Write-Host "MSIX package created successfully: $($msixPath.FullName)"
        shell: powershell

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinUninstallDoctorMSIX
          path: WinUninstallDoctor.Package/AppPackages/**/*.msix
